From 1d87f948ab16c17391ad9e43bf82ed6081bef48f Mon Sep 17 00:00:00 2001
From: "Uwe L. Korn" <uwe.korn@quantco.com>
Date: Fri, 2 Feb 2024 16:56:09 +0100
Subject: [PATCH 24/24] Link to absl_spinlock_wait

---
 cmake/protobuf.cmake | 30 ++++++++++--------------------
 1 file changed, 10 insertions(+), 20 deletions(-)

diff --git a/cmake/protobuf.cmake b/cmake/protobuf.cmake
index d50b124f..8b3958cf 100644
--- a/cmake/protobuf.cmake
+++ b/cmake/protobuf.cmake
@@ -179,26 +179,16 @@ MACRO(MYSQL_CHECK_PROTOBUF)
 
   FIND_PROTOBUF_VERSION()
 
-  # Version 22 and up depend on ~65 abseil .dylibs.
-  IF(APPLE AND WITH_PROTOBUF STREQUAL "system" AND
-      PB_MINOR_VERSION VERSION_GREATER 21)
-    # list(FILTER <list> {INCLUDE | EXCLUDE} REGEX <regex>)
-    FIND_OBJECT_DEPENDENCIES("${PROTOBUF_LIBRARY}" protobuf_dependencies)
-    LIST(FILTER protobuf_dependencies INCLUDE REGEX "${HOMEBREW_HOME}.*")
-    SET_TARGET_PROPERTIES(ext::libprotobuf PROPERTIES
-      INTERFACE_LINK_LIBRARIES "${protobuf_dependencies}"
-      )
-    FIND_OBJECT_DEPENDENCIES("${PROTOBUF_LITE_LIBRARY}" lite_dependencies)
-    LIST(FILTER lite_dependencies  INCLUDE REGEX "${HOMEBREW_HOME}.*")
-    SET_TARGET_PROPERTIES(ext::libprotobuf-lite PROPERTIES
-      INTERFACE_LINK_LIBRARIES "${lite_dependencies}"
-      )
-    FIND_OBJECT_DEPENDENCIES("${Protobuf_PROTOC_LIBRARY}" protoc_dependencies)
-    LIST(FILTER protoc_dependencies INCLUDE REGEX "${HOMEBREW_HOME}.*")
-    SET_TARGET_PROPERTIES(ext::libprotoc PROPERTIES
-      INTERFACE_LINK_LIBRARIES "${protoc_dependencies}"
-      )
-  ENDIF()
+  SET(protobuf_dependencies absl_spinlock_wait)
+  SET_TARGET_PROPERTIES(ext::libprotobuf PROPERTIES
+    INTERFACE_LINK_LIBRARIES "${protobuf_dependencies}"
+    )
+  SET_TARGET_PROPERTIES(ext::libprotobuf-lite PROPERTIES
+    INTERFACE_LINK_LIBRARIES "${protobuf_dependencies}"
+    )
+  SET_TARGET_PROPERTIES(ext::libprotoc PROPERTIES
+    INTERFACE_LINK_LIBRARIES "${protobuf_dependencies}"
+    )
 
   IF("${PROTOBUF_VERSION}" VERSION_LESS "${MIN_PROTOBUF_VERSION_REQUIRED}")
     COULD_NOT_FIND_PROTOBUF()
